{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/santiago.cardenas/Desktop/Proyectos/Proyecto de grado/BurstCar/front/burstCarFront/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { Geolocation } from '@capacitor/geolocation';\nimport { MapaSelectorComponent } from 'src/app/shared/mapa-selector/mapa-selector.component';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/app/shared/tracking/firebase-tracking.servicio\";\nimport * as i2 from \"@angular/forms\";\nimport * as i3 from \"@angular/router\";\nimport * as i4 from \"./servicio-actualizar-estado.servicio\";\nimport * as i5 from \"@angular/common\";\nimport * as i6 from \"@ionic/angular\";\nimport * as i7 from \"../../shared/mapa-selector/mapa-selector.component\";\nfunction TrackingPrestadorPage_ion_button_10_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"ion-button\", 12);\n    i0.ɵɵlistener(\"click\", function TrackingPrestadorPage_ion_button_10_Template_ion_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.iniciarTracking());\n    });\n    i0.ɵɵtext(1, \" Iniciar recorrido \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction TrackingPrestadorPage_ion_button_12_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r3 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"ion-button\", 13);\n    i0.ɵɵlistener(\"click\", function TrackingPrestadorPage_ion_button_12_Template_ion_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r3);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.cambiarEstadoEnOrigen());\n    });\n    i0.ɵɵtext(1, \" Llegu\\u00E9 al origen \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction TrackingPrestadorPage_ion_button_15_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r4 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"ion-button\", 14);\n    i0.ɵɵlistener(\"click\", function TrackingPrestadorPage_ion_button_15_Template_ion_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r4);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.finalizarTracking());\n    });\n    i0.ɵɵtext(1, \" Finalizar recorrido \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction TrackingPrestadorPage_div_16_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 15);\n    i0.ɵɵtext(1, \" Debes estar cerca del origen para iniciar el cambio de estado. \");\n    i0.ɵɵelementEnd();\n  }\n}\nexport let TrackingPrestadorPage = /*#__PURE__*/(() => {\n  class TrackingPrestadorPage {\n    constructor(firebaseTracking, fb, route, router, estadoServicio) {\n      this.firebaseTracking = firebaseTracking;\n      this.fb = fb;\n      this.route = route;\n      this.router = router;\n      this.estadoServicio = estadoServicio;\n      this.servicioId = '';\n      this.trackingActivo = false;\n      this.watchId = null;\n      this.puedeIniciarRecorrido = false;\n      this.puedeFinalizarRecorrido = false;\n      this.dummyForm = this.fb.group({\n        latitud: [''],\n        longitud: ['']\n      });\n    }\n    ngOnInit() {\n      this.servicioId = this.route.snapshot.paramMap.get('id') || '';\n      this.route.queryParams.subscribe(params => {\n        this.latitudOrigen = parseFloat(params['latitudOrigen']);\n        this.longitudOrigen = parseFloat(params['longitudOrigen']);\n        this.latitudDestino = parseFloat(params['latitudDestino']);\n        this.longitudDestino = parseFloat(params['longitudDestino']);\n        this.verificarCercanias();\n      });\n    }\n    verificarCercanias() {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        try {\n          const position = yield Geolocation.getCurrentPosition();\n          const latActual = position.coords.latitude;\n          const lngActual = position.coords.longitude;\n          const distanciaOrigen = _this.calcularDistanciaEnMetros(latActual, lngActual, _this.latitudOrigen, _this.longitudOrigen);\n          const distanciaDestino = _this.calcularDistanciaEnMetros(latActual, lngActual, _this.latitudDestino, _this.longitudDestino);\n          console.log('Distancia al origen:', distanciaOrigen, 'metros');\n          console.log('Distancia al destino:', distanciaDestino, 'metros');\n          _this.puedeIniciarRecorrido = distanciaOrigen <= 50;\n          _this.puedeFinalizarRecorrido = distanciaDestino <= 50;\n        } catch (error) {\n          console.error('Error obteniendo ubicación actual:', error);\n        }\n      })();\n    }\n    calcularDistanciaEnMetros(lat1, lon1, lat2, lon2) {\n      const R = 6371000;\n      const rad = x => x * Math.PI / 180;\n      const dLat = rad(lat2 - lat1);\n      const dLon = rad(lon2 - lon1);\n      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(rad(lat1)) * Math.cos(rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);\n      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n      return R * c;\n    }\n    iniciarRecorrido() {\n      var _this2 = this;\n      return _asyncToGenerator(function* () {\n        if (!_this2.puedeIniciarRecorrido) {\n          alert('Debes estar en el punto de origen para iniciar el tracking.');\n          return;\n        }\n        _this2.trackingActivo = true;\n        _this2.watchId = yield Geolocation.watchPosition({}, (position, err) => {\n          if (position) {\n            const lat = position.coords.latitude;\n            const lng = position.coords.longitude;\n            _this2.firebaseTracking.actualizarUbicacion(_this2.servicioId, lat, lng);\n            _this2.dummyForm.patchValue({\n              latitud: lat,\n              longitud: lng\n            });\n            _this2.mapaSelector.moverMarcador(lat, lng);\n            _this2.verificarCercanias();\n          }\n        });\n      })();\n    }\n    finalizarRecorrido() {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        if (_this3.intervalSimulacion) {\n          clearInterval(_this3.intervalSimulacion);\n        }\n        _this3.trackingActivo = false;\n        if (_this3.watchId) {\n          Geolocation.clearWatch({\n            id: _this3.watchId\n          });\n          yield _this3.firebaseTracking.eliminarTracking(_this3.servicioId);\n        }\n        _this3.estadoServicio.actualizarEstadoServicio(_this3.servicioId, {\n          estadoServicio: 'Finalizado'\n        }).subscribe({\n          next: () => console.log('Estado cambiado a Finalizado'),\n          error: err => console.error('Error cambiando estado:', err)\n        });\n        _this3.router.navigate(['/servicio/todos']);\n      })();\n    }\n    //Prueba movimiento \n    simularMovimiento() {\n      this.intervalSimulacion = setInterval(() => {\n        const latActual = this.dummyForm.value.latitud;\n        const lngActual = this.dummyForm.value.longitud;\n        const nuevoLat = latActual + 0.0001;\n        const nuevoLng = lngActual + 0.0001;\n        this.dummyForm.patchValue({\n          latitud: nuevoLat,\n          longitud: nuevoLng\n        });\n        this.firebaseTracking.actualizarUbicacion(this.servicioId, nuevoLat, nuevoLng);\n        this.mapaSelector.moverMarcador(nuevoLat, nuevoLng);\n      }, 2000);\n    }\n    cambiarEstadoServicioEnOrigen() {\n      const esatdo = {\n        estadoServicio: 'En transcurso'\n      };\n      this.estadoServicio.actualizarEstadoServicio(this.servicioId, esatdo).subscribe({\n        next: () => {\n          console.log('Estado actualizado correctamente');\n        },\n        error: err => {\n          console.error('Error al actualizar estado', err);\n        }\n      });\n    }\n    static {\n      this.ɵfac = function TrackingPrestadorPage_Factory(t) {\n        return new (t || TrackingPrestadorPage)(i0.ɵɵdirectiveInject(i1.FirebaseTrackingServicio), i0.ɵɵdirectiveInject(i2.FormBuilder), i0.ɵɵdirectiveInject(i3.ActivatedRoute), i0.ɵɵdirectiveInject(i3.Router), i0.ɵɵdirectiveInject(i4.EstadoServicio));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: TrackingPrestadorPage,\n        selectors: [[\"app-tracking-prestador\"]],\n        viewQuery: function TrackingPrestadorPage_Query(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵviewQuery(MapaSelectorComponent, 5);\n          }\n          if (rf & 2) {\n            let _t;\n            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.mapaSelector = _t.first);\n          }\n        },\n        decls: 17,\n        vars: 10,\n        consts: [[\"color\", \"primary\"], [1, \"consulta-background\"], [1, \"consulta-container\"], [3, \"formGroup\", \"soloLectura\", \"latitudOrigen\", \"longitudOrigen\", \"latitudDestino\", \"longitudDestino\"], [1, \"ion-justify-content-between\"], [\"size\", \"5\"], [\"expand\", \"block\", \"color\", \"success\", 3, \"click\", 4, \"ngIf\"], [\"expand\", \"block\", \"color\", \"warning\", 3, \"click\", 4, \"ngIf\"], [1, \"ion-justify-content-center\", 2, \"margin-top\", \"10px\"], [\"size\", \"10\"], [\"expand\", \"block\", \"color\", \"tertiary\", 3, \"click\", 4, \"ngIf\"], [\"style\", \"text-align: center; margin-top: 20px;\", 4, \"ngIf\"], [\"expand\", \"block\", \"color\", \"success\", 3, \"click\"], [\"expand\", \"block\", \"color\", \"warning\", 3, \"click\"], [\"expand\", \"block\", \"color\", \"tertiary\", 3, \"click\"], [2, \"text-align\", \"center\", \"margin-top\", \"20px\"]],\n        template: function TrackingPrestadorPage_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"ion-header\")(1, \"ion-toolbar\", 0)(2, \"ion-title\");\n            i0.ɵɵtext(3, \"Tracking Prestador\");\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵelementStart(4, \"ion-content\", 1)(5, \"div\", 2);\n            i0.ɵɵelement(6, \"app-mapa-selector\", 3);\n            i0.ɵɵelementStart(7, \"ion-grid\")(8, \"ion-row\", 4)(9, \"ion-col\", 5);\n            i0.ɵɵtemplate(10, TrackingPrestadorPage_ion_button_10_Template, 2, 0, \"ion-button\", 6);\n            i0.ɵɵelementEnd();\n            i0.ɵɵelementStart(11, \"ion-col\", 5);\n            i0.ɵɵtemplate(12, TrackingPrestadorPage_ion_button_12_Template, 2, 0, \"ion-button\", 7);\n            i0.ɵɵelementEnd()();\n            i0.ɵɵelementStart(13, \"ion-row\", 8)(14, \"ion-col\", 9);\n            i0.ɵɵtemplate(15, TrackingPrestadorPage_ion_button_15_Template, 2, 0, \"ion-button\", 10);\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵtemplate(16, TrackingPrestadorPage_div_16_Template, 2, 0, \"div\", 11);\n            i0.ɵɵelementEnd()();\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(6);\n            i0.ɵɵproperty(\"formGroup\", ctx.dummyForm)(\"soloLectura\", true)(\"latitudOrigen\", ctx.latitudOrigen)(\"longitudOrigen\", ctx.longitudOrigen)(\"latitudDestino\", ctx.latitudDestino)(\"longitudDestino\", ctx.longitudDestino);\n            i0.ɵɵadvance(4);\n            i0.ɵɵproperty(\"ngIf\", !ctx.trackingActivo);\n            i0.ɵɵadvance(2);\n            i0.ɵɵproperty(\"ngIf\", ctx.puedeCambiarEstadoEnOrigen && ctx.trackingActivo);\n            i0.ɵɵadvance(3);\n            i0.ɵɵproperty(\"ngIf\", ctx.puedeFinalizarTracking && ctx.trackingActivo);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", !ctx.puedeCambiarEstadoEnOrigen && !ctx.trackingActivo);\n          }\n        },\n        dependencies: [i5.NgIf, i6.IonButton, i6.IonCol, i6.IonContent, i6.IonGrid, i6.IonHeader, i6.IonRow, i6.IonTitle, i6.IonToolbar, i2.NgControlStatusGroup, i2.FormGroupDirective, i7.MapaSelectorComponent],\n        styles: [\".consulta-background[_ngcontent-%COMP%]{--background: #f5f5f5}.consulta-container[_ngcontent-%COMP%]{width:90%;margin:auto;padding-top:4vh}.map-button-base[_ngcontent-%COMP%], .map-button-light[_ngcontent-%COMP%], .map-button-dark[_ngcontent-%COMP%]{font-weight:600;--border-radius: 8px;transition:transform .2s ease,box-shadow .2s ease}.map-button-base[_ngcontent-%COMP%]:hover, .map-button-light[_ngcontent-%COMP%]:hover, .map-button-dark[_ngcontent-%COMP%]:hover{transform:translateY(-2px);box-shadow:0 4px 12px #0000004d}.map-button-base[_ngcontent-%COMP%]:active, .map-button-light[_ngcontent-%COMP%]:active, .map-button-dark[_ngcontent-%COMP%]:active{transform:scale(.97);box-shadow:0 2px 6px #0003}.map-button-dark[_ngcontent-%COMP%]{--background: #6c8f6d;--color: white}.map-button-light[_ngcontent-%COMP%]{--background: #f3f3e4;--color: #232020}\"]\n      });\n    }\n  }\n  return TrackingPrestadorPage;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}