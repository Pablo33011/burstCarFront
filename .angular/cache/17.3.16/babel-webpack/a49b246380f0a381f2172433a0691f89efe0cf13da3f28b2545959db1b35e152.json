{"ast":null,"code":"import _asyncToGenerator from \"C:/Users/santiago.cardenas/Desktop/Proyectos/Proyecto de grado/BurstCar/front/burstCarFront/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";\nimport { Geolocation } from '@capacitor/geolocation';\nimport { MapaSelectorComponent } from 'src/app/shared/mapa-selector/mapa-selector.component';\nimport * as i0 from \"@angular/core\";\nimport * as i1 from \"src/app/shared/tracking/firebase-tracking.servicio\";\nimport * as i2 from \"@angular/forms\";\nimport * as i3 from \"@angular/router\";\nimport * as i4 from \"@angular/common\";\nimport * as i5 from \"@ionic/angular\";\nimport * as i6 from \"../../shared/mapa-selector/mapa-selector.component\";\nfunction TrackingPrestadorPage_ion_button_9_Template(rf, ctx) {\n  if (rf & 1) {\n    const _r1 = i0.ɵɵgetCurrentView();\n    i0.ɵɵelementStart(0, \"ion-button\", 7);\n    i0.ɵɵlistener(\"click\", function TrackingPrestadorPage_ion_button_9_Template_ion_button_click_0_listener() {\n      i0.ɵɵrestoreView(_r1);\n      const ctx_r1 = i0.ɵɵnextContext();\n      return i0.ɵɵresetView(ctx_r1.finalizarTracking());\n    });\n    i0.ɵɵtext(1, \" Finalizar Tracking \");\n    i0.ɵɵelementEnd();\n  }\n}\nfunction TrackingPrestadorPage_div_10_Template(rf, ctx) {\n  if (rf & 1) {\n    i0.ɵɵelementStart(0, \"div\", 8);\n    i0.ɵɵtext(1, \" Debes estar en el punto de origen para iniciar el tracking. \");\n    i0.ɵɵelementEnd();\n  }\n}\nexport let TrackingPrestadorPage = /*#__PURE__*/(() => {\n  class TrackingPrestadorPage {\n    constructor(firebaseTracking, fb, route, router) {\n      this.firebaseTracking = firebaseTracking;\n      this.fb = fb;\n      this.route = route;\n      this.router = router;\n      this.servicioId = '';\n      this.trackingActivo = false;\n      this.watchId = null;\n      this.puedeIniciarTracking = false;\n      this.dummyForm = this.fb.group({\n        latitud: [''],\n        longitud: ['']\n      });\n    }\n    ngOnInit() {\n      this.servicioId = this.route.snapshot.paramMap.get('idServicio') || '';\n      this.route.queryParams.subscribe(params => {\n        this.latitudOrigen = parseFloat(params['latitudOrigen']);\n        this.longitudOrigen = parseFloat(params['longitudOrigen']);\n        this.verificarCercaniaAlOrigen();\n      });\n    }\n    verificarCercaniaAlOrigen() {\n      var _this = this;\n      return _asyncToGenerator(function* () {\n        try {\n          const position = yield Geolocation.getCurrentPosition();\n          const latActual = position.coords.latitude;\n          const lngActual = position.coords.longitude;\n          const distancia = _this.calcularDistanciaEnMetros(latActual, lngActual, _this.latitudOrigen, _this.longitudOrigen);\n          console.log('Distancia al origen:', distancia, 'metros');\n          _this.puedeIniciarTracking = distancia <= 50;\n        } catch (error) {\n          console.error('Error obteniendo ubicación actual:', error);\n        }\n      })();\n    }\n    calcularDistanciaEnMetros(lat1, lon1, lat2, lon2) {\n      const R = 6371000;\n      const rad = x => x * Math.PI / 180;\n      const dLat = rad(lat2 - lat1);\n      const dLon = rad(lon2 - lon1);\n      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(rad(lat1)) * Math.cos(rad(lat2)) * Math.sin(dLon / 2) * Math.sin(dLon / 2);\n      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));\n      return R * c;\n    }\n    iniciarTracking() {\n      var _this2 = this;\n      return _asyncToGenerator(function* () {\n        if (!_this2.puedeIniciarTracking) {\n          alert('Debes estar en el punto de origen para iniciar el tracking.');\n          return;\n        }\n        _this2.trackingActivo = true;\n        _this2.watchId = yield Geolocation.watchPosition({}, (position, err) => {\n          if (position) {\n            const lat = position.coords.latitude;\n            const lng = position.coords.longitude;\n            _this2.firebaseTracking.actualizarUbicacion(_this2.servicioId, lat, lng);\n            _this2.dummyForm.patchValue({\n              latitud: lat,\n              longitud: lng\n            });\n            _this2.mapaSelector.redibujarMapa();\n          }\n        });\n      })();\n    }\n    finalizarTracking() {\n      var _this3 = this;\n      return _asyncToGenerator(function* () {\n        _this3.trackingActivo = false;\n        if (_this3.watchId) {\n          Geolocation.clearWatch({\n            id: _this3.watchId\n          });\n          yield _this3.firebaseTracking.eliminarTracking(_this3.servicioId);\n        }\n        _this3.router.navigate(['/servicio/todos']);\n      })();\n    }\n    static {\n      this.ɵfac = function TrackingPrestadorPage_Factory(t) {\n        return new (t || TrackingPrestadorPage)(i0.ɵɵdirectiveInject(i1.FirebaseTrackingServicio), i0.ɵɵdirectiveInject(i2.FormBuilder), i0.ɵɵdirectiveInject(i3.ActivatedRoute), i0.ɵɵdirectiveInject(i3.Router));\n      };\n    }\n    static {\n      this.ɵcmp = /*@__PURE__*/i0.ɵɵdefineComponent({\n        type: TrackingPrestadorPage,\n        selectors: [[\"app-tracking-prestador\"]],\n        viewQuery: function TrackingPrestadorPage_Query(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵviewQuery(MapaSelectorComponent, 5);\n          }\n          if (rf & 2) {\n            let _t;\n            i0.ɵɵqueryRefresh(_t = i0.ɵɵloadQuery()) && (ctx.mapaSelector = _t.first);\n          }\n        },\n        decls: 11,\n        vars: 5,\n        consts: [[\"color\", \"primary\"], [1, \"consulta-background\"], [1, \"consulta-container\"], [3, \"formGroup\", \"soloLectura\"], [\"expand\", \"block\", \"color\", \"success\", 3, \"click\", \"disabled\"], [\"expand\", \"block\", \"color\", \"danger\", 3, \"click\", 4, \"ngIf\"], [\"style\", \"text-align: center; margin-top: 20px;\", 4, \"ngIf\"], [\"expand\", \"block\", \"color\", \"danger\", 3, \"click\"], [2, \"text-align\", \"center\", \"margin-top\", \"20px\"]],\n        template: function TrackingPrestadorPage_Template(rf, ctx) {\n          if (rf & 1) {\n            i0.ɵɵelementStart(0, \"ion-header\")(1, \"ion-toolbar\", 0)(2, \"ion-title\");\n            i0.ɵɵtext(3, \"Tracking Prestador\");\n            i0.ɵɵelementEnd()()();\n            i0.ɵɵelementStart(4, \"ion-content\", 1)(5, \"div\", 2);\n            i0.ɵɵelement(6, \"app-mapa-selector\", 3);\n            i0.ɵɵelementStart(7, \"ion-button\", 4);\n            i0.ɵɵlistener(\"click\", function TrackingPrestadorPage_Template_ion_button_click_7_listener() {\n              return ctx.iniciarTracking();\n            });\n            i0.ɵɵtext(8, \" Iniciar Tracking \");\n            i0.ɵɵelementEnd();\n            i0.ɵɵtemplate(9, TrackingPrestadorPage_ion_button_9_Template, 2, 0, \"ion-button\", 5)(10, TrackingPrestadorPage_div_10_Template, 2, 0, \"div\", 6);\n            i0.ɵɵelementEnd()();\n          }\n          if (rf & 2) {\n            i0.ɵɵadvance(6);\n            i0.ɵɵproperty(\"formGroup\", ctx.dummyForm)(\"soloLectura\", true);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"disabled\", !ctx.puedeIniciarTracking || ctx.trackingActivo);\n            i0.ɵɵadvance(2);\n            i0.ɵɵproperty(\"ngIf\", ctx.trackingActivo);\n            i0.ɵɵadvance();\n            i0.ɵɵproperty(\"ngIf\", !ctx.puedeIniciarTracking && !ctx.trackingActivo);\n          }\n        },\n        dependencies: [i4.NgIf, i5.IonButton, i5.IonContent, i5.IonHeader, i5.IonTitle, i5.IonToolbar, i2.NgControlStatusGroup, i2.FormGroupDirective, i6.MapaSelectorComponent],\n        styles: [\".consulta-background[_ngcontent-%COMP%]{--background: #f5f5f5}.consulta-container[_ngcontent-%COMP%]{width:90%;margin:auto;padding-top:4vh}\"]\n      });\n    }\n  }\n  return TrackingPrestadorPage;\n})();","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}